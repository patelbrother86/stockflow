<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StockFlow Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }
        .cart-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div id="login-view" class="flex flex-col items-center justify-center h-screen p-6">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-gray-100">
            <div class="bg-blue-600 w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                <span class="text-white text-3xl font-bold">S</span>
            </div>
            <h1 class="text-2xl font-black text-gray-800 text-center mb-2">StockFlow Pro</h1>
            <p class="text-gray-400 text-center mb-8 text-sm">Internal Staff Portal</p>
            
            <input type="text" id="username" placeholder="Username" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-3 outline-blue-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl mb-6 outline-blue-500">
            
            <button onclick="handleLogin()" id="login-btn" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg shadow-blue-200 shadow-lg active:scale-95 transition">Log In</button>
        </div>
    </div>

    <div id="dashboard-view" class="hidden flex flex-col h-screen">
        <header class="bg-white border-b p-4 flex justify-between items-center">
            <div>
                <h1 class="font-black text-blue-600 text-xl tracking-tight">STOCKFLOW</h1>
                <p id="user-display" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"></p>
            </div>
            <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-40">
            <section class="mb-6">
                <div class="flex p-1 bg-gray-200 rounded-xl mb-4">
                    <button id="tab-cam" onclick="switchMode('camera')" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow">Camera</button>
                    <button id="tab-hard" onclick="switchMode('hardware')" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500">Scanner Gun</button>
                </div>

                <div id="camera-box"><div id="reader"></div></div>
                <div id="hardware-box" class="hidden">
                    <input type="text" id="manual-input" class="w-full p-5 border-2 border-blue-100 rounded-2xl text-lg focus:border-blue-500 outline-none" placeholder="Awaiting Scan...">
                </div>

                <div id="scan-preview" class="mt-4 bg-blue-600 p-5 rounded-2xl shadow-xl hidden text-white">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 id="prev-name" class="text-xl font-bold leading-tight">Product Name</h3>
                            <p id="prev-price" class="text-2xl font-black mt-1">$0.00</p>
                        </div>
                        <button onclick="closePreview()" class="bg-blue-500 p-2 rounded-full">âœ•</button>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmAddToOrder()" class="flex-[2] bg-white text-blue-600 py-4 rounded-xl font-black shadow-lg">ADD ITEM</button>
                        <button onclick="closePreview()" class="flex-1 bg-blue-500 text-white py-4 rounded-xl font-bold">CANCEL</button>
                    </div>
                </div>

                <div id="add-product-card" class="mt-4 bg-yellow-400 p-5 rounded-2xl shadow-lg hidden">
                    <h3 class="font-black text-yellow-900 mb-3 uppercase text-sm italic">New Barcode Detected</h3>
                    <input type="text" id="new-name" placeholder="Item Name" class="w-full p-3 rounded-lg mb-2 border-none">
                    <input type="number" id="new-price" placeholder="Sale Price" class="w-full p-3 rounded-lg mb-4 border-none">
                    <button onclick="addNewProduct()" class="w-full bg-black text-white py-4 rounded-xl font-bold">REGISTER & ADD</button>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-black text-gray-800">CURRENT ORDER</h2>
                    <button onclick="clearCart()" class="text-xs font-bold text-red-500 uppercase tracking-wider">Clear All</button>
                </div>
                <div id="cart-items" class="space-y-3"></div>
                <div id="empty-msg" class="text-center py-12 text-gray-300 font-medium italic">No items scanned.</div>
            </section>
        </main>

        <footer id="checkout-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t p-6 shadow-2xl hidden transform translate-y-0 transition-transform">
            <div class="flex justify-between items-end mb-6">
                <span class="text-gray-400 font-bold uppercase text-xs tracking-widest">Total Payable</span>
                <span id="order-total" class="text-4xl font-black text-gray-900 leading-none">$0.00</span>
            </div>
            <button onclick="processCheckout()" id="checkout-btn" class="w-full bg-green-500 text-white py-5 rounded-2xl font-black text-xl shadow-green-100 shadow-2xl active:scale-95 transition">CONFIRM SALE</button>
        </footer>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3hIkbs8loGsJ0VQyBtYB4PnJl-Lsv1U83x2ENfDuMkM4g937p7Fu3-tOPgIhzRIGTEg/exec'; 
        let currentUser = null, currentRole = null, cart = [], tempProduct = null, scanner = null;

        function handleLogin() {
            const btn = document.getElementById('login-btn');
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return alert("Enter credentials");

            btn.disabled = true; btn.innerText = "Verifying...";
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: 'login', username: u, password: p }) })
            .then(res => res.json()).then(data => {
                if (data.success) {
                    currentUser = data.username; currentRole = data.role;
                    document.getElementById('user-display').innerText = `${currentUser} | ${currentRole}`;
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('dashboard-view').classList.remove('hidden');
                    initScanner();
                } else {
                    alert("Invalid Login");
                    btn.disabled = false; btn.innerText = "Log In";
                }
            }).catch(() => { alert("Check Script URL"); btn.disabled = false; });
        }

        function initScanner() {
            scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: {width: 250, height: 180} }, false);
            scanner.render(onScanSuccess);
        }

        function onScanSuccess(code) {
            scanner.pause();
            fetchProduct(code);
        }

        function fetchProduct(barcode) {
            fetch(`${SCRIPT_URL}?action=getProduct&barcode=${barcode}`)
            .then(res => res.json()).then(data => {
                if (data.error) {
                    if(currentRole === 'ADMIN') {
                        document.getElementById('add-product-card').classList.remove('hidden');
                        document.getElementById('new-name').dataset.barcode = barcode;
                    } else alert("Item Not Found");
                } else {
                    showPreview(data);
                }
            });
        }

        function showPreview(p) {
            tempProduct = p;
            document.getElementById('prev-name').innerText = p.name;
            document.getElementById('prev-price').innerText = `$${parseFloat(p.price).toFixed(2)}`;
            document.getElementById('scan-preview').classList.remove('hidden');
            document.getElementById('camera-box').classList.add('opacity-10');
        }

        function closePreview() {
            tempProduct = null;
            document.getElementById('scan-preview').classList.add('hidden');
            document.getElementById('camera-box').classList.remove('opacity-10');
            scanner.resume();
        }

        function confirmAddToOrder() {
            const existing = cart.find(i => i.id === tempProduct.id);
            if (existing) existing.qty++; else cart.push({ ...tempProduct, qty: 1 });
            renderCart();
            closePreview();
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                total += item.price * item.qty;
                container.innerHTML += `
                    <div class="cart-item bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-gray-800">${item.name}</p>
                            <p class="text-blue-600 font-black">$${item.price}</p>
                        </div>
                        <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-xl">
                            <button onclick="updateQty('${item.id}', -1)" class="w-8 h-8 bg-white rounded-lg shadow-sm font-bold">-</button>
                            <span class="font-bold w-4 text-center">${item.qty}</span>
                            <button onclick="updateQty('${item.id}', 1)" class="w-8 h-8 bg-white rounded-lg shadow-sm font-bold">+</button>
                        </div>
                    </div>`;
            });

            document.getElementById('empty-msg').classList.toggle('hidden', cart.length > 0);
            document.getElementById('checkout-bar').classList.toggle('hidden', cart.length === 0);
            document.getElementById('order-total').innerText = `$${total.toFixed(2)}`;
        }

        function updateQty(id, delta) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) cart = cart.filter(i => i.id !== id);
                renderCart();
            }
        }

        function processCheckout() {
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true; btn.innerText = "Processing Sheets...";
            
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: 'checkoutCart', items: cart, user: currentUser }) })
            .then(() => {
                alert("Order Finalized!");
                cart = []; renderCart();
                btn.disabled = false; btn.innerText = "CONFIRM SALE";
            });
        }

        function addNewProduct() {
            const name = document.getElementById('new-name').value;
            const price = document.getElementById('new-price').value;
            const barcode = document.getElementById('new-name').dataset.barcode;
            if(!name || !price) return alert("Fill all fields");

            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: 'addProduct', barcode, name, price, stock: 0, user: currentUser }) 
            }).then(() => {
                document.getElementById('add-product-card').classList.add('hidden');
                fetchProduct(barcode);
            });
        }

        function switchMode(m) {
            document.getElementById('camera-box').classList.toggle('hidden', m === 'hardware');
            document.getElementById('hardware-box').classList.toggle('hidden', m === 'camera');
            document.getElementById('tab-cam').className = m === 'camera' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow' : 'flex-1 py-2 rounded-lg text-sm font-bold text-gray-500';
            document.getElementById('tab-hard').className = m === 'hardware' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow' : 'flex-1 py-2 rounded-lg text-sm font-bold text-gray-500';
            if(m === 'hardware') { scanner.pause(); setTimeout(()=>document.getElementById('manual-input').focus(), 100); }
            else { scanner.resume(); }
        }

        document.getElementById('manual-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { fetchProduct(e.target.value); e.target.value = ''; }
        });

        function clearCart() { if(confirm("Clear order?")) { cart = []; renderCart(); } }
        function logout() { location.reload(); }
    </script>
</body>
</html>