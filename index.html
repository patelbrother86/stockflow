<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StockFlow Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<link rel="manifest" href="data:application/manifest+json,{'name':'StockFlow','short_name':'StockFlow','start_url':'.','display':'standalone','background_color':'#ffffff','theme_color':'#2563eb'}">
</head>
<body class="bg-slate-50 min-h-screen font-sans antialiased text-slate-900">

<div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
<div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 border border-slate-100">
<div class="text-center mb-8">
<div class="inline-flex items-center justify-center w-20 h-20 bg-blue-600 text-white rounded-2xl mb-4 rotate-3 shadow-xl shadow-blue-200">
<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
</svg>
</div>
<h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">StockFlow</h2>
<p class="text-slate-500 font-medium">Internal Inventory Portal</p>
</div>
<div class="space-y-4">
<input type="text" id="username" placeholder="Username" class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
<input type="password" id="password" placeholder="Password" class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
<button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-100 active:scale-95 transition-all">Sign In</button>
<p id="login-msg" class="text-center text-red-500 text-sm font-semibold"></p>
</div>
</div>
</div>

<div id="scanner-screen" class="hidden max-w-2xl mx-auto p-4 md:p-8">
<header class="flex justify-between items-center mb-8">
<h1 class="text-2xl font-black text-blue-600 tracking-tighter">STOCKFLOW</h1>
<div class="text-right">
<p class="text-xs font-bold text-slate-400 uppercase tracking-widest" id="display-user"></p>
<button onclick="location.reload()" class="text-xs text-red-500 font-bold hover:underline">LOGOUT</button>
</div>
</header>

<div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 p-4 mb-6">
<div id="reader" class="rounded-2xl overflow-hidden"></div>
<div id="status" class="py-4 text-center font-bold text-slate-400 animate-pulse text-sm">Waiting for scan...</div>
</div>

<div id="product-card" class="hidden space-y-4 animate-in fade-in slide-in-from-bottom-8 duration-500">
<div class="bg-white rounded-3xl p-6 shadow-2xl border-l-8 border-blue-600">
<div class="flex justify-between items-start mb-4">
<h3 id="prod-name" class="text-2xl font-bold text-slate-800">---</h3>
<span id="prod-price-display" class="bg-blue-100 text-blue-700 font-black px-3 py-1 rounded-lg text-xl">$0.00</span>
</div>

<div class="flex gap-4 mb-6">
<div class="flex-1 bg-slate-50 p-3 rounded-2xl">
<p class="text-[10px] font-bold text-slate-400 uppercase">Current Stock</p>
<p id="prod-stock" class="text-2xl font-black text-slate-800">0</p>
</div>
</div>

<button id="sale-btn" onclick="apiAction('purchase')" class="w-full bg-blue-600 text-white font-bold py-5 rounded-2xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
PROCESS SALE (-1)
</button>

<div id="admin-panel" class="hidden mt-6 pt-6 border-t border-slate-100 space-y-4">
<p class="text-xs font-black text-slate-400 uppercase tracking-widest">Inventory Management</p>
<button onclick="apiAction('restock')" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">
ADD TO STOCK (+1)
</button>
<div class="flex gap-2">
<input type="number" id="new-price" placeholder="Set Price" class="flex-1 bg-slate-50 border border-slate-200 px-4 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
<button onclick="updatePrice()" class="bg-slate-800 text-white px-6 font-bold rounded-2xl active:scale-95 transition-all">Update Price</button>
</div>
</div>

<button onclick="resetScanner()" class="w-full mt-4 py-2 text-slate-400 font-bold text-sm">Cancel Scan</button>
</div>
</div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbx3hIkbs8loGsJ0VQyBtYB4PnJl-Lsv1U83x2ENfDuMkM4g937p7Fu3-tOPgIhzRIGTEg/exec";
let currentUser = "";
let userRole = "";
let lastBarcode = "";
let html5QrCode;

async function login() {
const user = document.getElementById('username').value;
const pass = document.getElementById('password').value;
const msg = document.getElementById('login-msg');
if(!user || !pass) return;

msg.innerText = "Authenticating...";
const res = await fetch(`${scriptUrl}?action=login&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`);
const role = await res.text();

if (role !== "auth_fail") {
userRole = role;
currentUser = user;
document.getElementById('display-user').innerText = `${user} â€¢ ${role}`;
if(role === "Admin") document.getElementById('admin-panel').classList.remove('hidden');
document.getElementById('login-screen').classList.add('hidden');
document.getElementById('scanner-screen').classList.remove('hidden');
initScanner();
} else {
msg.innerText = "Invalid credentials";
}
}

function initScanner() {
html5QrCode = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
html5QrCode.render(onScanSuccess);
}

async function onScanSuccess(decodedText) {
if(lastBarcode === decodedText) return;
lastBarcode = decodedText;
document.getElementById('status').innerText = "Reading database...";

const res = await fetch(`${scriptUrl}?action=check&barcode=${decodedText}`);
const data = await res.json();

document.getElementById('prod-name').innerText = data.name;
document.getElementById('prod-price-display').innerText = "$" + parseFloat(data.price).toFixed(2);
document.getElementById('prod-stock').innerText = data.stock;
document.getElementById('product-card').classList.remove('hidden');
document.getElementById('status').innerText = "Barcode Locked";
if (navigator.vibrate) navigator.vibrate(100);
}

async function apiAction(type) {
const res = await fetch(`${scriptUrl}?action=${type}&barcode=${lastBarcode}&user=${encodeURIComponent(currentUser)}`);
alert(await res.text());
resetScanner();
}

async function updatePrice() {
const price = document.getElementById('new-price').value;
if(!price) return;
const res = await fetch(`${scriptUrl}?action=updatePrice&barcode=${lastBarcode}&user=${encodeURIComponent(currentUser)}&price=${price}`);
alert(await res.text());
resetScanner();
}

function resetScanner() {
document.getElementById('product-card').classList.add('hidden');
document.getElementById('status').innerText = "Waiting for scan...";
lastBarcode = "";
document.getElementById('new-price').value = "";
}
</script>
</body>
</html>